const DECRYPT=0,ROUND=32,BLOCK=16,Sbox=[214,144,233,254,204,225,61,183,22,182,20,194,40,251,44,5,43,103,154,118,42,190,4,195,170,68,19,38,73,134,6,153,156,66,80,244,145,239,152,122,51,84,11,67,237,207,172,98,228,179,28,169,201,8,232,149,128,223,148,250,117,143,63,166,71,7,167,252,243,115,23,186,131,89,60,25,230,133,79,168,104,107,129,178,113,100,218,139,248,235,15,75,112,86,157,53,30,36,14,94,99,88,209,162,37,34,124,59,1,33,120,135,212,0,70,87,159,211,39,82,76,54,2,231,160,196,200,158,234,191,138,210,64,199,56,181,163,247,242,206,249,97,21,161,224,174,93,164,155,52,26,85,173,147,50,48,245,140,177,227,29,246,226,46,130,102,202,96,192,41,35,171,13,83,78,111,213,219,55,69,222,253,142,47,3,255,106,114,109,108,91,81,141,27,175,146,187,221,188,127,17,217,92,65,31,16,90,216,10,193,49,136,165,205,123,189,45,116,208,18,184,229,180,176,137,105,151,74,12,150,119,126,101,185,241,9,197,110,198,132,24,240,125,236,58,220,77,32,121,238,95,62,215,203,57,72],CK=[462357,472066609,943670861,1415275113,1886879365,2358483617,2830087869,3301692121,3773296373,4228057617,404694573,876298825,1347903077,1819507329,2291111581,2762715833,3234320085,3705924337,4177462797,337322537,808926789,1280531041,1752135293,2223739545,2695343797,3166948049,3638552301,4110090761,269950501,741554753,1213159005,1684763257];function hexToArray(t){const r=[];for(let n=0,o=t.length;n<o;n+=2)r.push(parseInt(t.substr(n,2),16));return r}function ArrayToHex(t){return t.map(t=>1===(t=t.toString(16)).length?"0"+t:t).join("")}function utf8ToArray(t){const r=[];for(let n=0,o=t.length;n<o;n++){const o=t.codePointAt(n);if(o<=127)r.push(o);else if(o<=2047)r.push(192|o>>>6),r.push(128|63&o);else if(o<=55295||o>=57344&&o<=65535)r.push(224|o>>>12),r.push(128|o>>>6&63),r.push(128|63&o);else{if(!(o>=65536&&o<=1114111))throw r.push(o),new Error("input is not supported");n++,r.push(240|o>>>18&28),r.push(128|o>>>12&63),r.push(128|o>>>6&63),r.push(128|63&o)}}return r}function arrayToUtf8(t){const r=[];for(let n=0,o=t.length;n<o;n++)t[n]>=240&&t[n]<=247?(r.push(String.fromCodePoint(((7&t[n])<<18)+((63&t[n+1])<<12)+((63&t[n+2])<<6)+(63&t[n+3]))),n+=3):t[n]>=224&&t[n]<=239?(r.push(String.fromCodePoint(((15&t[n])<<12)+((63&t[n+1])<<6)+(63&t[n+2]))),n+=2):t[n]>=192&&t[n]<=223?(r.push(String.fromCodePoint(((31&t[n])<<6)+(63&t[n+1]))),n++):r.push(String.fromCodePoint(t[n]));return r.join("")}function rotl(t,r){return t<<r|t>>>32-r}function byteSub(t){return(255&Sbox[t>>>24&255])<<24|(255&Sbox[t>>>16&255])<<16|(255&Sbox[t>>>8&255])<<8|255&Sbox[255&t]}function l1(t){return t^rotl(t,2)^rotl(t,10)^rotl(t,18)^rotl(t,24)}function l2(t){return t^rotl(t,13)^rotl(t,23)}function sms4Crypt(t,r,n){const o=new Array(4),e=new Array(4);for(let r=0;r<4;r++)e[0]=255&t[4*r],e[1]=255&t[4*r+1],e[2]=255&t[4*r+2],e[3]=255&t[4*r+3],o[r]=e[0]<<24|e[1]<<16|e[2]<<8|e[3];for(let t,r=0;r<32;r+=4)t=o[1]^o[2]^o[3]^n[r+0],o[0]^=l1(byteSub(t)),t=o[2]^o[3]^o[0]^n[r+1],o[1]^=l1(byteSub(t)),t=o[3]^o[0]^o[1]^n[r+2],o[2]^=l1(byteSub(t)),t=o[0]^o[1]^o[2]^n[r+3],o[3]^=l1(byteSub(t));for(let t=0;t<16;t+=4)r[t]=o[3-t/4]>>>24&255,r[t+1]=o[3-t/4]>>>16&255,r[t+2]=o[3-t/4]>>>8&255,r[t+3]=255&o[3-t/4]}function sms4KeyExt(t,r,n){const o=new Array(4),e=new Array(4);for(let r=0;r<4;r++)e[0]=255&t[0+4*r],e[1]=255&t[1+4*r],e[2]=255&t[2+4*r],e[3]=255&t[3+4*r],o[r]=e[0]<<24|e[1]<<16|e[2]<<8|e[3];o[0]^=2746333894,o[1]^=1453994832,o[2]^=1736282519,o[3]^=2993693404;for(let t,n=0;n<32;n+=4)t=o[1]^o[2]^o[3]^CK[n+0],r[n+0]=o[0]^=l2(byteSub(t)),t=o[2]^o[3]^o[0]^CK[n+1],r[n+1]=o[1]^=l2(byteSub(t)),t=o[3]^o[0]^o[1]^CK[n+2],r[n+2]=o[2]^=l2(byteSub(t)),t=o[0]^o[1]^o[2]^CK[n+3],r[n+3]=o[3]^=l2(byteSub(t));if(n===DECRYPT)for(let t,n=0;n<16;n++)t=r[n],r[n]=r[31-n],r[31-n]=t}function sm4(t,r,n,{padding:o="pkcs#7",mode:e,iv:s=[],output:u="string"}={}){if("cbc"===e&&("string"==typeof s&&(s=hexToArray(s)),16!==s.length))throw new Error("iv is invalid");if("string"==typeof r&&(r=hexToArray(r)),16!==r.length)throw new Error("key is invalid");if(t="string"==typeof t?n!==DECRYPT?utf8ToArray(t):hexToArray(t):[...t],("pkcs#5"===o||"pkcs#7"===o)&&n!==DECRYPT){const r=BLOCK-t.length%BLOCK;for(let n=0;n<r;n++)t.push(r)}const i=new Array(ROUND);sms4KeyExt(r,i,n);const f=[];let l=s,c=t.length,p=0;for(;c>=BLOCK;){const r=t.slice(p,p+16),o=new Array(16);if("cbc"===e)for(let t=0;t<BLOCK;t++)n!==DECRYPT&&(r[t]^=l[t]);sms4Crypt(r,o,i);for(let t=0;t<BLOCK;t++)"cbc"===e&&n===DECRYPT&&(o[t]^=l[t]),f[p+t]=o[t];"cbc"===e&&(l=n!==DECRYPT?o:r),c-=BLOCK,p+=BLOCK}if(("pkcs#5"===o||"pkcs#7"===o)&&n===DECRYPT){const t=f[f.length-1];f.splice(f.length-t,t)}return"array"!==u?n!==DECRYPT?ArrayToHex(f):arrayToUtf8(f):f}function encrypt(t,r,n){return sm4(t,r,1,n)}function decrypt(t,r,n){return sm4(t,r,0,n)}export{encrypt,decrypt};